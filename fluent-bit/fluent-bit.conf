[SERVICE]
    Flush           5
    Daemon          Off
    Log_Level       info
    Parsers_File    parsers.conf
    # Persist file tracking offsets across restarts
    storage.path    /var/lib/fluent-bit/
    # Built-in Prometheus-style metrics endpoint for local diagnostics
    HTTP_Server     On
    HTTP_Listen     0.0.0.0
    HTTP_Port       2020

# ==============================================================
# Input: read all systemd journal entries
# ==============================================================
[INPUT]
    Name            systemd
    Tag             edge.*
    Read_From_Tail  On
    Strip_Underscores On
    Lowercase       On
    DB              /var/lib/fluent-bit/systemd.db

# ==============================================================
# Input: CPU metrics
# ==============================================================
[INPUT]
    Name            cpu
    Tag             metrics.cpu
    Interval_Sec    15

# ==============================================================
# Input: Memory metrics
# ==============================================================
[INPUT]
    Name            mem
    Tag             metrics.mem
    Interval_Sec    15

# ==============================================================
# Input: Disk I/O metrics
# ==============================================================
[INPUT]
    Name            disk
    Tag             metrics.disk
    Interval_Sec    15

# ==============================================================
# Input: Network I/O metrics
# ==============================================================
[INPUT]
    Name            netif
    Tag             metrics.net
    Interval_Sec    15
    Interface       eth0

# ==============================================================
# Input: Thermal / temperature metrics
# ==============================================================
[INPUT]
    Name            thermal
    Tag             metrics.thermal
    Interval_Sec    15

# ==============================================================
# Filter: add device metadata to logs
# ==============================================================
[FILTER]
    Name            modify
    Match           edge.*
    Add             source edge

# Use Lua to map numeric priority to severity label
[FILTER]
    Name            lua
    Match           edge.*
    script          /etc/fluent-bit/severity.lua
    call            add_severity

# ==============================================================
# Filter: stamp metrics with device hostname
# ==============================================================
[FILTER]
    Name            lua
    Match           metrics.*
    script          /etc/fluent-bit/hostname.lua
    call            add_hostname

# ==============================================================
# Output: forward logs to central Fluentd collector
# ==============================================================
[OUTPUT]
    Name            forward
    Match           edge.*
    Host            sentry.meticulousespresso.com
    Port            24225
    Tag             edge
    tls             On
    tls.verify      On
    Retry_Limit     False
    Shared_Key      meticulous-edge-logs

# ==============================================================
# Output: forward metrics to central Fluentd collector
# Tags are preserved (metrics.cpu, metrics.mem, etc.) so
# Fluentd can route and expose them as Prometheus metrics.
# ==============================================================
[OUTPUT]
    Name            forward
    Match           metrics.*
    Host            sentry.meticulousespresso.com
    Port            24225
    tls             On
    tls.verify      On
    Retry_Limit     False
    Shared_Key      meticulous-edge-logs
