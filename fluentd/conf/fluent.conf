## ============================================================
## Sources
## ============================================================

# Edge device forward input (Fluent Bit on edge devices)
# Listens with TLS + shared_key for authentication
<source>
  @type forward
  port 24225
  bind 0.0.0.0
  tag edge
  <security>
    self_hostname sentry.meticulousespresso.com
    shared_key meticulous-edge-logs
  </security>
  <transport tls>
    cert_path /etc/letsencrypt/live/sentry.meticulousespresso.com/fullchain.pem
    private_key_path /etc/letsencrypt/live/sentry.meticulousespresso.com/privkey.pem
  </transport>
</source>

## ============================================================
## Filters
## ============================================================

# --- Edge device journal: enrich with source and normalize severity ---
# Must run BEFORE remove_keys so that priority is still available for mapping
<filter edge.**>
  @type record_transformer
  enable_ruby true
  <record>
    source "edge"
    device_host ${record["hostname"] || "unknown"}
    device_unit ${record["systemd_unit"] || record["syslog_identifier"] || "unknown"}
    severity ${record["priority"] ? (begin; %w[emerg alert crit err warning notice info debug][record["priority"].to_i]; rescue; record["priority"] || "unknown"; end) : "unknown"}
  </record>
</filter>

# --- Edge device journal: drop noisy systemd metadata fields ---
# These cause ES mapping conflicts (e.g. cap_effective as hex string vs long)
# and are not useful for log analysis. priority is removed because severity
# already contains the human-readable version.
<filter edge.**>
  @type record_transformer
  remove_keys cap_effective,exe,cmdline,runtime_scope,systemd_cgroup,systemd_slice,systemd_invocation_id,stream_id,machine_id,boot_id,comm,transport,uid,gid,pid,syslog_facility,priority
</filter>

## ============================================================
## Outputs
## ============================================================

# --- Edge device journal logs â†’ ES index ---
<match edge.**>
  @type copy

  <store>
    @type elasticsearch
    host elasticsearch
    port 9200
    user elastic
    password "#{ENV['ELASTIC_PASSWORD']}"
    logstash_format true
    logstash_prefix logs-edge
    logstash_dateformat %Y%m%d
    include_tag_key true
    tag_key @log_name
    flush_interval 1s
    <buffer>
      flush_mode interval
      flush_interval 1s
      retry_max_interval 30
      retry_forever true
    </buffer>
  </store>

  <store>
    @type stdout
  </store>
</match>

# --- Catch-all: discard anything else ---
<match **>
  @type null
</match>
