<system>
  log_level warn
</system>

## ============================================================
## Sources
## ============================================================

# Edge device forward input (Fluent Bit on edge devices)
# Listens with TLS + shared_key for authentication.
# Receives log records (tag: edge.**) and metric records
# (tag: metrics.**) from edge Fluent Bit.
<source>
  @type forward
  port 24225
  bind 0.0.0.0
  <security>
    self_hostname sentry.meticulousespresso.com
    shared_key meticulous-edge-logs
  </security>
  <transport tls>
    cert_path /etc/letsencrypt/live/sentry.meticulousespresso.com/fullchain.pem
    private_key_path /etc/letsencrypt/live/sentry.meticulousespresso.com/privkey.pem
  </transport>
</source>

# Prometheus metrics endpoint — exposes Fluentd internal metrics
# AND edge device metrics (converted from forwarded records below)
<source>
  @type prometheus
  bind 0.0.0.0
  port 24231
  metrics_path /metrics
</source>

<source>
  @type prometheus_monitor
</source>

<source>
  @type prometheus_output_monitor
</source>

## ============================================================
## Filters — edge device logs
## ============================================================

# --- Enrich with source and normalize severity ---
# Must run BEFORE remove_keys so that priority is still available for mapping
<filter edge.**>
  @type record_transformer
  enable_ruby true
  <record>
    source "edge"
    device_host ${record["hostname"] || "unknown"}
    device_unit ${record["systemd_unit"] || record["syslog_identifier"] || "unknown"}
    severity ${record["priority"] ? (begin; %w[emerg alert crit err warning notice info debug][record["priority"].to_i]; rescue; record["priority"] || "unknown"; end) : "unknown"}
  </record>
</filter>

# --- Drop noisy systemd metadata fields ---
<filter edge.**>
  @type record_transformer
  remove_keys cap_effective,exe,cmdline,runtime_scope,systemd_cgroup,systemd_slice,systemd_invocation_id,stream_id,machine_id,boot_id,comm,transport,uid,gid,pid,syslog_facility,priority
</filter>

## ============================================================
## Filters — edge device metrics → Prometheus gauges
## ============================================================
## Each filter converts forwarded metric records into Prometheus
## gauges exposed on :24231/metrics. Alloy scrapes them there
## and remote-writes to Mimir.

# --- CPU metrics (from Fluent Bit cpu input) ---
<filter metrics.cpu>
  @type prometheus
  <metric>
    name edge_cpu_usage_percent
    type gauge
    desc CPU usage percentage (all cores average)
    key cpu_p
    <labels>
      device_host ${device_host}
    </labels>
  </metric>
  <metric>
    name edge_cpu_user_percent
    type gauge
    desc CPU user space percentage
    key user_p
    <labels>
      device_host ${device_host}
    </labels>
  </metric>
  <metric>
    name edge_cpu_system_percent
    type gauge
    desc CPU kernel space percentage
    key system_p
    <labels>
      device_host ${device_host}
    </labels>
  </metric>
</filter>

# --- Memory metrics (from Fluent Bit mem input) ---
<filter metrics.mem>
  @type prometheus
  <metric>
    name edge_memory_total_bytes
    type gauge
    desc Total memory in KB (Fluent Bit mem plugin reports KB)
    key Mem.total
    <labels>
      device_host ${device_host}
    </labels>
  </metric>
  <metric>
    name edge_memory_used_bytes
    type gauge
    desc Used memory in KB (Fluent Bit mem plugin reports KB)
    key Mem.used
    <labels>
      device_host ${device_host}
    </labels>
  </metric>
  <metric>
    name edge_memory_free_bytes
    type gauge
    desc Free memory in KB (Fluent Bit mem plugin reports KB)
    key Mem.free
    <labels>
      device_host ${device_host}
    </labels>
  </metric>
  <metric>
    name edge_swap_total_bytes
    type gauge
    desc Total swap in KB (Fluent Bit mem plugin reports KB)
    key Swap.total
    <labels>
      device_host ${device_host}
    </labels>
  </metric>
  <metric>
    name edge_swap_used_bytes
    type gauge
    desc Used swap in KB (Fluent Bit mem plugin reports KB)
    key Swap.used
    <labels>
      device_host ${device_host}
    </labels>
  </metric>
</filter>

# --- Disk I/O metrics (from Fluent Bit disk input) ---
<filter metrics.disk>
  @type prometheus
  <metric>
    name edge_disk_read_bytes
    type gauge
    desc Disk read bytes
    key read_size
    <labels>
      device_host ${device_host}
    </labels>
  </metric>
  <metric>
    name edge_disk_write_bytes
    type gauge
    desc Disk write bytes
    key write_size
    <labels>
      device_host ${device_host}
    </labels>
  </metric>
</filter>

# --- Network I/O metrics (from Fluent Bit netif input) ---
<filter metrics.net>
  @type prometheus
  <metric>
    name edge_net_rx_bytes
    type gauge
    desc Network receive bytes
    key eth0.rx.bytes
    <labels>
      device_host ${device_host}
    </labels>
  </metric>
  <metric>
    name edge_net_tx_bytes
    type gauge
    desc Network transmit bytes
    key eth0.tx.bytes
    <labels>
      device_host ${device_host}
    </labels>
  </metric>
</filter>

# --- Thermal metrics (from Fluent Bit thermal input) ---
<filter metrics.thermal>
  @type prometheus
  <metric>
    name edge_thermal_celsius
    type gauge
    desc Device temperature in celsius
    key temp
    <labels>
      device_host ${device_host}
    </labels>
  </metric>
</filter>

## ============================================================
## Outputs — edge device logs
## ============================================================

<match edge.**>
  @type copy

  # --- Store 1: Loki ---
  <store>
    @type loki
    url http://loki:3100
    flush_interval 1s
    flush_at_shutdown true
    line_format json
    <label>
      source
      device_host
      device_unit
      severity
    </label>
    remove_keys source,device_host,device_unit,severity
    extra_labels {"job":"edge"}
    <buffer>
      flush_mode interval
      flush_interval 1s
      retry_max_interval 30
      retry_forever true
    </buffer>
  </store>

</match>

## ============================================================
## Outputs — edge device metrics (discard after prometheus filter)
## The prometheus filter already captured the values as gauges.
## ============================================================

<match metrics.**>
  @type null
</match>

# --- Catch-all: discard anything else ---
<match **>
  @type null
</match>
